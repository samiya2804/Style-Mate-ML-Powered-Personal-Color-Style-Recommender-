<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload the image</title>
    <link rel="stylesheet" href="./static/css/upload.css">
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    {% extends "base.html" %}

    {% block title %}Home - StyleMate{% endblock %}
    
    {% block content %}

    <section class="grid-container">
        <div class="card upload-card" data-aos="fade-right" style="order: 1;">
            <h2>Upload Your Selfie</h2>
            <p>Select a well-lit image for best results:</p>
           <span style="color: #6c757d; font-size: 13px; font-style: italic; display: block;">
            <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
            Supported formats: <strong>JPG</strong>, <strong>PNG</strong>, and <strong>JPEG</strong>
            </span>

            <div class="file-input-wrapper">
                <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data" >
                <input type="file" id="upload" name="file" class="file-input" accept=".jpg, .jpeg & .png" required />
                <label for="upload">Choose File</label>

                <input type="hidden" name="hair" id="hairPoint">
                <input type="hidden" name="eye" id="eyePoint">
                <input type="hidden" name="skin" id="skinPoint">
        
                <button type="submit"  id="analyzeButton" disabled>Upload & Analyze</button>
                </form>
            </div>
           
            <p id="file-name-display" class="file-name-bottom"></p>
        </div>
        
        <div class="card" id="canvas-card" style="padding: 20px; display: none; grid-column: span 2; order: 2;" data-aos="fade-up">
            <h3 style="margin-bottom: 15px; font-size: 1.5em; color: #333;"><i class="fas fa-palette"></i> Image Preview & Color Selection</h3>
            
            <p id="instructions" style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #d8648f; border: 1px solid #ffccdd; padding: 10px; border-radius: 8px;">
            <i class="fas fa-mouse-pointer"></i> Instructions will load here.</p>

            <div class="preview-boxes" style="margin-bottom: 20px; text-align: center;">
                <div id="hairColorBox" class="color-box" onclick="reselect('hair')"><i class="fas fa-crown"></i> Hair</div>
                <div id="eyeColorBox" class="color-box" onclick="reselect('eye')"><i class="fas fa-eye"></i> Eye</div>
                <div id="skinColorBox" class="color-box" onclick="reselect('skin')"><i class="fas fa-tint"></i> Skin</div>
            </div>

            <div style="position: relative; text-align: center; max-width: 100%;">
                <canvas id="imageCanvas" style="max-width: 100%; height: auto; border: 2px solid #333; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: block; margin: 0 auto;"></canvas>
                
                <div id="swatch" style="
                    width: 40px; 
                    height: 40px;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.4);
                    border: 3px solid #e37fa4; 
                    position: absolute;
                    top: 100px;
                    left: 100px;
                    cursor: grab;
                    display: none;
                    box-shadow: 0 0 10px rgba(0,0,0,0.5); 
                    z-index: 10;
                ">
                </div>

                <canvas id="zoomCanvas" width="150" height="150" style="
                    border: 3px solid #e37fa4; 
                    box-shadow: 0 0 15px rgba(0,0,0,0.2);
                    display: block; 
                    z-index: 5;
                "></canvas>
            </div>
        </div>
        
        <div class="card" data-aos="fade-left" style="order: 3;">
            <h2>Color-Analyze Yourself</h2>
            <p>Discover your ideal color palette using AI — simply upload your selfie and let us guide your style journey.</p>
        </div>
        <div class="card" data-aos="fade-up" style="order: 4;">
            <h2>How It Works</h2>
            <ul>
                <li>Take a clear selfie in daylight</li>
                <li>Upload your image below</li>
                <li>Get instant palette results</li>
            </ul>
        </div>
        <div class="card" data-aos="fade-right" style="order: 5;">
            <h2>Why It Matters</h2>
            <p>Wearing the right colors enhances your look, brightens your appearance, and improves confidence.</p>
        </div>
        <div class="card" data-aos="fade-left" style="order: 6;">
            <h2>Your Privacy</h2>
            <p>We don’t store or share your image. All processing is secure and viewable only by you.</p>
        </div>
    </section>

<style>
/* --- Core Element Styling Improvements --- */
.color-box {
    width: 80px; 
    height: 40px;
    display: inline-flex; 
    justify-content: center;
    align-items: center;
    margin: 5px; 
    border: 2px solid #555;
    text-align: center;
    font-size: 14px; 
    font-weight: bold;
    color: #333; 
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.color-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}

#canvas-card {
    display: inline-block;
    flex-direction: column;
    align-items: center;
}

/* --- Responsive Layout for Zoom Canvas --- */

/* Mobile Styling (Default for max-width: 768px) */
@media(max-width:768px){
    /* Center the canvas in its container */
    #imageCanvas {
        width: 100% !important; /* Force full width on mobile */
        height: auto !important;
    }
    
    /* Position zoom canvas below the main canvas and center it */
    #zoomCanvas{
        position: static !important; /* Remove absolute positioning */
        margin: 20px auto 0 auto; /* Margin above, auto margins to center */
    }
    
    /* The main grid should stack items naturally (default) */
    .grid-container {
        display: block !important; 
        margin-bottom: 1rem;
    }
    .card{
      margin-bottom: 1rem;
    }
}

/* Desktop Styling (min-width: 768px) */
@media(min-width:768px){
    /* Ensure the grid container structure is maintained */
    .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* Assuming 4 columns total */
        gap: 20px;
    }
    
    /* Ensure the Canvas card spans enough columns on desktop */
    #canvas-card {
        grid-column: span 2; /* Make the canvas card take up two columns */
    }
    
    /* Position zoom canvas absolutely to the right of the main canvas */
    #zoomCanvas{
        position: absolute !important;
              top: 117px;
        left: -415px; /* Adjust based on zoom canvas size + margin */
        margin-left: 0 !important;
    }
    
    /* Ensure the wrapper accommodates the zoom box */
    .card:nth-child(6) { /* Targeting the 6th card (canvas card) */
        overflow: visible; 
    }
}
</style>

<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
AOS.init();
</script>


<script>
// Define currentStep in the global scope so reselect can access it
let currentStep = 0; 

document.addEventListener("DOMContentLoaded", function () {
    const uploadInput = document.getElementById("upload");
    const fileNameDisplay = document.getElementById("file-name-display");
    const canvasCard = document.getElementById("canvas-card");
    const canvas = document.getElementById("imageCanvas");
    const ctx = canvas.getContext("2d");
    const swatch = document.getElementById("swatch");
    const instructions = document.getElementById("instructions");
    const zoomCanvas = document.getElementById("zoomCanvas");
    const zoomCtx = zoomCanvas.getContext("2d");
    
    document.getElementById("analyzeButton").disabled = true;

    const labels = ["hair", "eye", "skin"];

    let dragging = false;
    let offsetX = 0, offsetY = 0;

    const image = new Image();
    let originalImageWidth = 0;
    let originalImageHeight = 0;
    
    // Initial instruction text when the card is hidden
    instructions.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload an image above to start color selection.';


    uploadInput.addEventListener("change", function () {
        const file = uploadInput.files[0];
        if (!file) return;

        fileNameDisplay.textContent = "File selected: " + file.name;
        document.getElementById("analyzeButton").disabled = true;

        const reader = new FileReader();
        reader.onload = function (e) {
            image.onload = function () {
                originalImageWidth = image.width;
                originalImageHeight = image.height;
                
                // Max size for professional look
                const maxWidth = 500; 
                const maxHeight = 500; 
                
                let ratio = Math.min(maxWidth / originalImageWidth, maxHeight / originalImageHeight);
                if(ratio > 1) ratio = 1; 

                canvas.width = originalImageWidth * ratio;
                canvas.height = originalImageHeight * ratio;

                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                
                // --- Start Sequence Reset ---
                swatch.style.display = "block";
                canvasCard.style.display = "block";
                
                // Set initial instructions for HAIR
                instructions.innerHTML = `<i class="fas fa-hand-point-up"></i> **Step 1: Hair.** Drag the swatch over your hair color, then **tap the swatch** to confirm.`;
                
                // Initial swatch position near the center of the canvas area
                swatch.style.left = (canvas.width / 2 - swatch.offsetWidth / 2) + "px";
                swatch.style.top = (canvas.height / 2 - swatch.offsetHeight / 2) + "px";
                
                // Clear color boxes and points on new upload
                labels.forEach(label => {
                    document.getElementById(label + "ColorBox").style.backgroundColor = 'transparent';
                    document.getElementById(label + "ColorBox").style.color = '#333';
                    document.getElementById(label + "Point").value = "";
                });
                currentStep = 0;
                
            };
            image.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });

    // We now need to scale the coordinates when getting RGB and setting hidden inputs
    function getScaledCoordinates(swatchX, swatchY) {
        const scaleFactorX = originalImageWidth / canvas.width;
        const scaleFactorY = originalImageHeight / canvas.height;

        const originalX = Math.round(swatchX * scaleFactorX);
        const originalY = Math.round(swatchY * scaleFactorY);
        
        return { originalX, originalY };
    }

    function getRGBat(canvasX, canvasY) {
        const data = ctx.getImageData(canvasX, canvasY, 1, 1).data;
        return [data[0], data[1], data[2]];
    }

    function updateColorBox(id, rgb) {
        const box = document.getElementById(id + "ColorBox");
        box.style.backgroundColor = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        box.style.color = (rgb[0] * 0.299 + rgb[1] * 0.587 + rgb[2] * 0.114) > 186 ? '#000' : '#fff'; // Adjust text color for contrast
    }

    function updateZoom(x, y) {
        const size = 15; 
        const zoom = 10; 
        
        const imageData = ctx.getImageData(x - size / 2, y - size / 2, size, size);
        
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = size;
        tempCanvas.height = size;
        const tempCtx = tempCanvas.getContext("2d");
        tempCtx.putImageData(imageData, 0, 0);

        zoomCtx.clearRect(0, 0, zoomCanvas.width, zoomCanvas.height);
        zoomCtx.imageSmoothingEnabled = false; 
        zoomCtx.drawImage(tempCanvas, 0, 0, size, size, 0, 0, zoomCanvas.width, zoomCanvas.height);

        // Center pixel indicator
        zoomCtx.strokeStyle = '#333';
        zoomCtx.strokeRect(zoomCanvas.width / 2 - zoom / 2, zoomCanvas.height / 2 - zoom / 2, zoom, zoom);
    }

    swatch.addEventListener("mousedown", (e) => {
        dragging = true;
        offsetX = e.clientX - swatch.getBoundingClientRect().left;
        offsetY = e.clientY - swatch.getBoundingClientRect().top;
        swatch.style.cursor = "grabbing";
    });
    
    // Add touch support for mobile dragging
    swatch.addEventListener("touchstart", (e) => {
        e.preventDefault(); // Prevents click event firing later
        dragging = true;
        const touch = e.touches[0];
        offsetX = touch.clientX - swatch.getBoundingClientRect().left;
        offsetY = touch.clientY - swatch.getBoundingClientRect().top;
        swatch.style.cursor = "grabbing";
    });

    document.addEventListener("mouseup", () => {
        dragging = false;
        swatch.style.cursor = "grab";
    });
    
    // Add touch end support
    document.addEventListener("touchend", () => {
        dragging = false;
        swatch.style.cursor = "grab";
    });


    document.addEventListener("mousemove", (e) => {
        if (!dragging) return;

        const rect = canvas.getBoundingClientRect();
        let x = e.clientX - rect.left - offsetX;
        let y = e.clientY - rect.top - offsetY;

        x = Math.max(0, Math.min(x, rect.width - swatch.offsetWidth));
        y = Math.max(0, Math.min(y, rect.height - swatch.offsetHeight));
        
        swatch.style.left = x + "px";
        swatch.style.top = y + "px";

        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const centerCanvasX = (x + swatch.offsetWidth / 2) * scaleX;
        const centerCanvasY = (y + swatch.offsetHeight / 2) * scaleY;
        
        updateZoom(centerCanvasX, centerCanvasY);
    });
    
    // Add touch move support
    document.addEventListener("touchmove", (e) => {
        if (!dragging || !e.touches[0]) return;
        e.preventDefault(); // Stop scrolling/page movement
        
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        let x = touch.clientX - rect.left - offsetX;
        let y = touch.clientY - rect.top - offsetY;

        x = Math.max(0, Math.min(x, rect.width - swatch.offsetWidth));
        y = Math.max(0, Math.min(y, rect.height - swatch.offsetHeight));
        
        swatch.style.left = x + "px";
        swatch.style.top = y + "px";

        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const centerCanvasX = (x + swatch.offsetWidth / 2) * scaleX;
        const centerCanvasY = (y + swatch.offsetHeight / 2) * scaleY;
        
        updateZoom(centerCanvasX, centerCanvasY);
    });


    // Swatch Click/Tap to Confirm
    function confirmSelection(e) {
        if (currentStep >= labels.length) return;
        
        const rect = canvas.getBoundingClientRect();
        
        const swatchLeft = parseInt(swatch.style.left);
        const swatchTop = parseInt(swatch.style.top);

        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const centerCanvasX = (swatchLeft + swatch.offsetWidth / 2) * scaleX;
        const centerCanvasY = (swatchTop + swatch.offsetHeight / 2) * scaleY;

        const rgb = getRGBat(Math.round(centerCanvasX), Math.round(centerCanvasY));
        updateColorBox(labels[currentStep], rgb);

        const { originalX, originalY } = getScaledCoordinates(centerCanvasX, centerCanvasY);
        document.getElementById(labels[currentStep] + "Point").value = `${originalX},${originalY}`;
        
        // --- Advance Step ---
        currentStep++;
        if (currentStep < labels.length) {
            const nextLabel = labels[currentStep].toUpperCase();
            instructions.innerHTML = `<i class="fas fa-hand-point-up"></i> **Step ${currentStep + 1}: ${nextLabel}.** Drag the swatch over your ${nextLabel} color, then **tap the swatch** to confirm.`;
        } else {
            instructions.innerHTML = '<i class="fas fa-check-circle"></i> **Complete!** All colors selected. Click **Upload & Analyze** to see your results.';
            document.getElementById("analyzeButton").disabled = false;
            swatch.style.display = 'none'; // Hide swatch after final selection
        }
    }

    swatch.addEventListener("click", confirmSelection);
    swatch.addEventListener("touchend", confirmSelection); // Use touchend for tap confirmation
});

function reselect(label) {
    const labels = ["hair", "eye", "skin"];
    const index = labels.indexOf(label);
    const swatch = document.getElementById("swatch");
    const instructions = document.getElementById("instructions");
    
    if (index !== -1) {
        currentStep = index;
        const currentLabel = label.toUpperCase();
        instructions.innerHTML = `<i class="fas fa-redo"></i> **Reselecting ${currentLabel}.** Drag the swatch to the new location, then **tap the swatch** to confirm.`;
        document.getElementById("analyzeButton").disabled = true;
        swatch.style.display = 'block'; // Show swatch for re-selection
        
        // Reset the corresponding color box
        document.getElementById(label + "ColorBox").style.backgroundColor = 'transparent';
        document.getElementById(label + "ColorBox").style.color = '#333';
        document.getElementById(label + "Point").value = "";
    }
}
</script>
    {% endblock %}  
</body>
</html>